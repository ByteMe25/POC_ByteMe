<!DOCTYPE html> 
<html lang="it">
    <head> 
        <meta charset="UTF-8"> 
        <meta name="viewport" content="width=device-width, initial-scale=1.0 "> 
        <title>Second Brain Editor - PoC ByteMe</title>
        
        <link rel="stylesheet" href="https://unpkg.com/easymde/dist/easymde.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
        
        <link rel="stylesheet" href="style.css">
    </head>

    <body>
        <!--barra in alto sopra la toolbar con nome editor e opzioni su file
        Usa icona del cervello nel titolo h1: fa-solid usa stile pieno (riempie l'icona), fa-brain prende icona del cervello
        (da libreria FontAwesome) -->
        <div class="top-bar">
            <div class="doc-title-wrapper">
                <h1><i class="fa-solid fa-brain"></i> Second Brain Editor</h1>
                <h2></h2>
                <input type="text" id="doc-title" class="doc-title-input" placeholder="Titolo del documento..." value="Nuova nota...">
            </div>
            
            <div class="actions">
                <button class="action-btn" onclick="triggerUpload()">
                    <i class="fa-solid fa-folder-open"></i> Carica
                </button>
                <button class="action-btn" onclick="downloadFile()">
                    <i class="fa-solid fa-floppy-disk"></i> Salva
                </button>
            </div>
        </div>

        <div class="editor-container">
            <textarea id="my-editor"></textarea>
        </div>

        <input type="file" id="file-input" accept=".md,.txt">

    <script src="https://unpkg.com/easymde/dist/easymde.min.js"></script>
    <!--Toastify per notifiche e messaggi feedback belli-->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <script>
        // Funzione Helper per Notifiche belle (toastify)
        function notify(msg, type = "info") {
            let cssClass = type === "error" ? "toast-error" : "toast-success"; //classe css scelta in base al tipo di messaggio
            Toastify({
                text: msg,
                duration: 3000,
                gravity: "bottom", 
                position: "right",
                className: "toast-base " + cssClass 
            }).showToast();
        }

        // Operazioni easyMDE nella toolbar, icone già fornite separate da |
        const easyMDE = new EasyMDE({ element: document.getElementById('my-editor'),
        spellChecker: false, //disattiva correttore inglese (default)
        autofocus: true,
        //quando split view è attiva non va a schermo intero (si vede titolo h1)
        sideBySideFullscreen: false,

        toolbar: ["bold", "italic", "strikethrough",
        //per fare sottolineato usa sintassi html (easyMDE non lo include)
        {
            name: "underline",
            action: function(editor){
                var cm = editor.codemirror;
                var selectedText = cm.getSelection();
                var text = selectedText || "testo"; 
                cm.replaceSelection("<u>" + text + "</u>");
            },
            className: "fa fa-underline",
            title: "Sottolineato",
        }, "|",

        // HEADINGS
        "heading-smaller", "heading-bigger", "|",

        // ALTRI ELEMENTI
        "code", "quote", "table", "link", "image", "|",

        // OPERAZIONI DI UNDO E REDO
        "undo", "redo", "|",

        // ELENCHI
        "unordered-list", "ordered-list", "|",

        // OPERAZIONI DI COPIA, INCOLLA E TAGLIA
        {
            name: "copy",
            action: function(editor){
                //prende testo selezionato
                var txt = editor.codemirror.getSelection(); 
                if(!txt) return notify("Seleziona del testo prima!", "error");
                navigator.clipboard.writeText(txt)
                .then(() => notify("Copiato negli appunti!"))
                .catch(e => notify("Errore copia browser", "error"));
            },
            className: "fa fa-copy", //icona fogli
            title: "Copy (Ctrl+C)"
        },
        {
            //problemi di sicurezza per l'incolla: browsr bloccano questa funzione per siti non sicuri
            name: "paste",
            action: function(editor){
                navigator.clipboard.readText()
                .then(t => editor.codemirror.replaceSelection(t))
                .catch(e => notify("Usa CTRL+V per incollare", "error"));
            },
            className: "fa fa-paste", //icona cartellina
            title: "Paste (Ctrl+V)"
        },
        {
            name: "cut",
            action: function(editor){
                var cm = editor.codemirror; 
                var txt = cm.getSelection();
                if(!txt) return notify("Seleziona del testo!", "error");
                navigator.clipboard.writeText(txt).then(() => {
                    cm.replaceSelection("");
                    notify("Testo tagliato!"); //feedback
                });
            },
            className: "fa fa-scissors", //icona forbice
            title: "Cut (Ctrl+Z)"
        },
        "|",

        // ALTRE ICONE DI UTILITY
        // "clean-block", //pulisce formattazione: rimuove solo intestazioni e liste
        "side-by-side", //anteprima laterale
        "fullscreen", //schermo intero
        "guide" //link alla guida Markdown
        ] });

        easyMDE.toggleSideBySide();

        // FUNZIONI PER I BOTTONI ESTERNI (carica file e scarica file)
        function downloadFile() {
            var testo = easyMDE.value();
            if(testo.trim() === "") {
                notify("Il documento è vuoto!", "error");
                return;
            }
            
            // prende il nome dal campo input
            var titolo = document.getElementById('doc-title').value || "nota-senza-nome";
            //pulisce il titolo da caratteri vietati nei file
            titolo = titolo.replace(/[^a-z0-9\s-_]/gi, '_').trim();
            var blob = new Blob([testo], { type: "text/markdown;charset=utf-8" });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = titolo + ".md"; //usa il nome scelto dall'utente
            a.click();
            URL.revokeObjectURL(url);
            
            notify("File salvato: " + titolo + ".md");
        }

        function triggerUpload() {
            document.getElementById('file-input').click();
        }

        // CARICA FILE
        document.getElementById('file-input').addEventListener('change', function(event) {
            var file = event.target.files[0];
            if (!file) return;

            var reader = new FileReader();
            reader.onload = function(e) {
                easyMDE.value(e.target.result);
                // AGGIORNA IL TITOLO QUANDO CARICHI UN FILE e rimuove l'estensione .md o .txt dal nome
                let nomeFile = file.name.replace(/\.[^/.]+$/, "");
                document.getElementById('doc-title').value = nomeFile;
                notify("File caricato: " + file.name);
                event.target.value = ''; 
            };
            reader.readAsText(file);
        });

    </script> 
    </body> 
</html>
